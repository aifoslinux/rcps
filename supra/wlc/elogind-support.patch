From 8f3239172c49a683cf926a6981eb3302e6d3227e Mon Sep 17 00:00:00 2001
From: dudemanguy <random342@airmail.cc>
Date: Wed, 13 Sep 2017 15:37:09 -0500
Subject: [PATCH] Add elogind support

---
 CMake/FindElogind.cmake | 40 ++++++++++++++++++++++++++++++++++++++++
 CMakeLists.txt          |  4 +++-
 src/CMakeLists.txt      | 13 +++++++++++++
 src/session/logind.c    |  8 +++++++-
 4 files changed, 63 insertions(+), 2 deletions(-)
 create mode 100644 CMake/FindElogind.cmake

diff --git a/CMake/FindElogind.cmake b/CMake/FindElogind.cmake
new file mode 100644
index 0000000..b30a19f
--- /dev/null
+++ b/CMake/FindElogind.cmake
@@ -0,0 +1,40 @@
+#.rst:
+# FindElogind
+# -------
+#
+# Find Elogind library
+#
+# Try to find Elogind library on UNIX systems. The following values are defined
+#
+# ::
+#
+#   ELOGIND_FOUND         - True if Elogind is available
+#   ELOGIND_INCLUDE_DIRS  - Include directories for Elogind
+#   ELOGIND_LIBRARIES     - List of libraries for Elogind
+#   ELOGIND_DEFINITIONS   - List of definitions for Elogind
+#
+#=============================================================================
+# Copyright (c) 2015 Jari Vetoniemi
+#
+# Distributed under the OSI-approved BSD License (the "License");
+#
+# This software is distributed WITHOUT ANY WARRANTY; without even the
+# implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
+# See the License for more information.
+#=============================================================================
+
+include(FeatureSummary)
+set_package_properties(Elogind PROPERTIES
+   URL "https://github.com/elogind/elogind"
+   DESCRIPTION "Elogind User, Seat and Session Manager")
+
+find_package(PkgConfig)
+pkg_check_modules(PC_ELOGIND QUIET libelogind)
+find_library(ELOGIND_LIBRARIES NAMES elogind ${PC_ELOGIND_LIBRARY_DIRS})
+find_path(ELOGIND_INCLUDE_DIRS elogind/sd-login.h HINTS ${PC_ELOGIND_INCLUDE_DIRS})
+
+set(ELOGIND_DEFINITIONS ${PC_ELOGIND_CFLAGS_OTHER})
+
+include(FindPackageHandleStandardArgs)
+find_package_handle_standard_args(ELOGIND DEFAULT_MSG ELOGIND_INCLUDE_DIRS ELOGIND_LIBRARIES)
+mark_as_advanced(ELOGIND_INCLUDE_DIRS ELOGIND_LIBRARIES ELOGIND_DEFINITIONS)
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 4a830c7..832a397 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -81,7 +81,9 @@ if (${CMAKE_SYSTEM_NAME} STREQUAL "Linux")
    set_package_properties(Dbus PROPERTIES TYPE RECOMMENDED PURPOSE "Enables logind support")
    find_package(Systemd)
    set_package_properties(Systemd PROPERTIES TYPE RECOMMENDED PURPOSE "Enables logind support")
-endif()
+   find_package(Elogind)
+   set_package_properties(Elogind PROPERTIES TYPE RECOMMENDED PURPOSE "Enables logind support")
+endif ()
 
 if (NOT WLC_BUILD_STATIC)
    set(BUILD_SHARED_LIBS ON)
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 5f0b4c7..36a7e15 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -100,6 +100,19 @@ if (SYSTEMD_FOUND)
    endif ()
 endif ()
 
+if (ELOGIND_FOUND)
+   add_definitions(${ELOGIND_DEFINITIONS})
+   include_directories(${ELOGIND_INCLUDE_DIRS})
+
+   if (DBUS_FOUND)
+      add_definitions(-DHAS_LOGIND)
+      list(APPEND sources session/logind.c)
+      list(APPEND libs ${ELOGIND_LIBRARIES})
+   else ()
+      message("Dbus was not found, so logind is disabled")
+   endif ()
+endif ()
+
 if (WLC_WAYLAND_BACKEND_SUPPORT)
    add_definitions(-DENABLE_WAYLAND_BACKEND)
    include_directories(${WAYLAND_CLIENT_INCLUDE_DIRS})
diff --git a/src/session/logind.c b/src/session/logind.c
index d105af6..b932e0c 100644
--- a/src/session/logind.c
+++ b/src/session/logind.c
@@ -6,8 +6,14 @@
 #include <fcntl.h>
 #include <sys/stat.h>
 #include <sys/sysmacros.h>
-#include <systemd/sd-login.h>
 #include <chck/string/string.h>
+
+#if SYSTEMD_FOUND
+   #include <systemd/sd-login.h>
+#elif ELOGIND_FOUND
+   #include <elogind/sd-login.h>
+#endif
+
 #include "internal.h"
 #include "dbus.h"
 #include "logind.h"
