PKG=qt5-webengine
VER=5.9.1
SRC=http://download.qt.io/official_releases/qt/${VER%.*}/$VER/submodules/${PKG/5-/}-opensource-src-$VER.tar.xz

build() {
    $PATCH/default-pthread-stacksize.patch
    $PATCH/musl-fixes.patch
    $PATCH/musl-no-gold.patch
    $PATCH/resolver.patch
    $PATCH/qtwebengine-no-mallinfo.patch
    $PATCH/qtwebengine-gn_bootstrap.patch
    $PATCH/qtwebengine-no-execinfo.patch
    $PATCH/qtwebengine-qt-musl-off_t.patch
    $PATCH/qtwebengine-qt-musl-set_thread_name_np.patch
    $PATCH/qtwebengine-qt-musl-stackframe.patch
    $PATCH/qtwebengine-qt-sandbox.patch

    ln -s /bin/ninja src/3rdparty/ninja/ninja
    cp -p $RCP_DIR/resolv_compat.h src/3rdparty/chromium/net/dns/
    # Do not use experimental allocator shim (incompatible with musl libc)
    sed -i src/3rdparty/chromium/build/common.gypi \
        -e"s;\('use_experimental_allocator_shim%':\) 1,;\1 0,;"

    cd $BLD_DIR

    qmake $SRC_DIR \
        CONFIG+="proprietary-codecs" \
        WEBENGINE_CONFIG+="use_proprietary_codecs use_system_ffmpeg use_system_icu"
    make
    make INSTALL_ROOT=$PKG_DIR install

    # Drop QMAKE_PRL_BUILD_DIR because reference the build dir
    find $LIB_DIR -type f -name '*.prl' \
        -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \;
}
